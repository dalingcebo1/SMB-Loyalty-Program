# SMB-Loyalty-Program

![Frontend CI](https://github.com/dalingcebo1/SMB-Loyalty-Program/actions/workflows/frontend-ci.yml/badge.svg)
![Backend CI](https://github.com/dalingcebo1/SMB-Loyalty-Program/actions/workflows/backend-ci.yml/badge.svg)
![E2E Tests](https://github.com/dalingcebo1/SMB-Loyalty-Program/actions/workflows/e2e-tests.yml/badge.svg)
![Deploy](https://github.com/dalingcebo1/SMB-Loyalty-Program/actions/workflows/deploy.yml/badge.svg)

We’re building a modern loyalty infrastructure that empowers small businesses and global enterprises alike to reward customers through seamless digital experiences—starting with QR-based programs for SMBs, and evolving into a blockchain-powered loyalty protocol for the future of partner ecosystems.

## GitHub Secrets
Add the following secrets under Settings > Secrets > Actions in your GitHub repository:

- **AWS_ACCESS_KEY_ID**: AWS access key for deployment actions
- **AWS_SECRET_ACCESS_KEY**: AWS secret access key for deployment actions
- **AWS_REGION**: AWS region for S3 and Elastic Beanstalk (e.g., `us-east-1`)
- **S3_BUCKET_NAME**: S3 bucket name for frontend hosting
- **EB_S3_BUCKET**: S3 bucket name for Elastic Beanstalk application versions

## Backend Development Environment

### Python Version
The backend targets Python 3.11 (CI currently runs 3.10/3.12 for compatibility). Use 3.11 locally for closest parity.

### Installing Dependencies
```
cd Backend
pip install -r requirements.txt
# Optional (dev tooling):
pip install ruff mypy pip-audit pytest-cov
```

### Editor Import Warnings (Pylance / VS Code)
If you see "Import ... could not be resolved" warnings:
1. Ensure the interpreter selected in VS Code is the one where you installed deps.
2. Pylance may need the workspace root (monorepo) – add a `.env` at repo root with:
```
PYTHONPATH=Backend
```
3. Run `pip install -r Backend/requirements.txt` inside an activated virtualenv.
4. Set `python.analysis.extraPaths` to `["Backend"]` in `.vscode/settings.json` (optional).

### Linting & Formatting (Ruff)
```
ruff check Backend
```
Project rules are in `pyproject.toml`. Line length set to 100. To auto-fix:
```
ruff check Backend --fix
```

### Type Checking (Mypy)
```
mypy Backend
```
`ignore_missing_imports` is enabled initially; tighten this over time by adding per-module stubs.

### Tests
```
pytest -q
```
Run with coverage:
```
pytest --cov=Backend --cov-report=term-missing -q
```

### Security Audit
```
pip-audit -r Backend/requirements.txt
```
Currently non-blocking in CI; convert to blocking once critical issues addressed.

### Running the API Locally
```
uvicorn main:app --reload --port 8000
```
Environment variables are loaded from `Backend/.env` (see `config.py`).

### Structured Logging
Production uses JSON logs; locally you get human-readable logs. To preview prod style:
```
ENVIRONMENT=production uvicorn main:app --port 8000
```

### Sentry (Optional)
Set `SENTRY_DSN` to enable Sentry. Tracing sample rate defaults to 0.1.

### Rate Limiting Notes
Token bucket logic is in `app/core/rate_limit.py`. Public metadata and user/tenant scoped endpoints have explicit limits. Future global middleware can wrap all routes if threat model changes.

### Docker Build (Multi-stage)
```
docker build -t loyalty-backend -f Backend/Dockerfile Backend
docker run -p 8000:8000 loyalty-backend
```

### OpenAPI Snapshot & Contract Checks
We enforce stability of existing public API paths via two mechanisms:

1. `Backend/tests/test_openapi_contract.py` – asserts critical endpoints are present.
2. `Backend/tests/test_openapi_snapshot.py` + `Backend/tests/openapi_snapshot.json` – snapshot diff.

Regenerating the snapshot (when intentionally adding/removing endpoints):
```
./Backend/scripts/update_openapi_snapshot.sh
git add Backend/tests/openapi_snapshot.json
```
CI will fail if the snapshot file still contains the placeholder `_requires_init` key or if previously recorded paths disappear without an updated snapshot.

### Migration Drift Check
CI runs a migration drift check (`scripts/check_migration_drift.py`) to detect when model changes aren't captured in Alembic migrations. If it fails:
```
alembic -c Backend/alembic.ini revision --autogenerate -m "sync models"
alembic -c Backend/alembic.ini upgrade head
```
Review the autogenerated migration for unintended operations before committing.

### Coverage Threshold
Backend quality workflow enforces a coverage floor (currently 75%). Raise incrementally as the codebase matures.

### Makefile Targets
Quick helpers:
```
make snapshot-openapi   # regenerate OpenAPI snapshot
make test               # run backend tests
make backend-quality    # lint + type + coverage
```

### New Endpoint Gate
Adding endpoints without updating the snapshot now fails the test unless you set `ALLOW_NEW_ENDPOINTS=1` (temporary override for PR). Standard flow:
```
make snapshot-openapi
git add Backend/tests/openapi_snapshot.json
```

### Load Testing (k6)
Basic traffic scenario lives in `Backend/loadtests/basic_traffic.js`.
Run locally (needs k6 installed):
```
k6 run Backend/loadtests/basic_traffic.js --env API_BASE=http://localhost:8000 --env TEST_USER=demo@example.com --env TEST_PASS=password
```

### Stricter Typing (Payments Module Pilot)
`app.plugins.payments.*` now uses stricter mypy settings (disallow untyped defs, implicit optional, etc.). Expand this pattern gradually to other critical modules after addressing type gaps.


## Frontend Development Quick Start
```
cd Frontend
npm install
npm run dev
```

API base URL configured via `VITE_API_BASE_URL` (see `Frontend/.env.example` if present).

